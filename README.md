# Домашнее задание к занятию 6. «Troubleshooting» - Дрибноход Давид

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её нужно прервать.

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;

Ответ: Получу список операций при помощи db.currentOp(), найду в списке нужную операцию и возьму её id, прерву операцию при помощи db.killOp() передав команде id операции.

- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

Ответ: Для предотварщения такой ситуации можно использовать параметр maxTimeMS при запуске операции, что ограничит время её выполнения, либо оптимизировать запрос так чтобы он выполнялся за приемлемое время.

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная иувеличивается пропорционально количеству реплик сервиса.

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?

Ответ: Предполагаю, что проблема появляется из-за того, что в одну и туже секунду истёкшими становятся огромное кол-во ключей. Redis запускает автоматическую очистку ключей, после очистки видит что истёкших ключей по прежнему много и запускает очистку повторно, при этом блокируются операции записи для уменьшения количества одновременно истекающих ключей.

## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базыпользователи начали жаловаться на ошибки вида:

```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```
Как вы думаете, почему это начало происходить и как локализовать проблему?

Ответ: Вероятно это могло произойти из-за того, что в связи с ростом числа записей в таблице, запрос начал выполняться слишком долго и соединение обрывается по таймауту. Можно провести проверку запустив Inspect на запросе и сравнить время выполнения с таймаутом, либо как вариант увеличить таймаут на ожидание ответа.

Какие пути решения этой проблемы вы можете предложить?

Ответ: Попробовать решить проблему можно несколькими способами:  
- Оптимизировать запрос
- Увеличить таймаут ожидания в запросе
- Разделить таблицу, либо сделать её срез
- Построить более эффективные индексы
- Перейти на более производительную, при работе с большими объёмами данных, СУБД


## Задача 4

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Ответ: Вероятно БД пытается выйти за пределы объёма доступной оперативной памяти хоста.

Как бы вы решили эту проблему?

Ответ: Для решения проблемы можно попробовать следующие варианты:
   * Увеличить объём оперативной памяти на хосте
   * Обратить внимание на параметры напрямую связанные с использованием оперативной памяти хоста. Такие параметры как shared_buffer, effective_cache_size. Настроить эти параметры так, чтобы система не пыталась выйти за пределы достпной на хосте оперативной памяти
   * Увеличить объём swap - что может негативно сказаться на производительности системы

---
